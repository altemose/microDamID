#Bash Commands for Initial Read Mapping and Processing of Single-Cell DamID Data from Altemose et al. 2019
#Nicolas Altemose, UC Berkeley, 2019
#requires bwa (v0.7.15-r1140), bedtools (v2.28.0), trimmomatic (v0.39), samtools (v1.9)

#starting in a directory containing raw sequencing files plus supplementary files and scripts (adapters-PE.fa, GRCh38.chromsizes.txt, DamLamPlasmid.fasta, mTracerPlasmid.fasta, GetGATCfrags_v4.pl)
#create subdirectories
mkdir 0_reference/
mkdir 1_raw/
mkdir 2_trimmed/
mkdir 3_aligned/
mkdir 4_merged/
mkdir 5_fragcov/
mkdir 6_LADcov/
mkdir tmp/
mkdir software/
mkdir plots/

#first install bwa, bedtools, trimmomatic, samtools into software/ directory
#then move perl scripts to this directory
mv GetGATCfrags_v4.pl software/

#move raw sequencing files to 1_raw/, plasmid sequences to Reference/, adapters to 2_trimmed/, bed files to 6_LADcov/
mv *.fastq.gz 1_raw
mv *fasta 0_reference
mv adapters-PE.fa 2_trimmed
mv *bed 6_LADcov/

#create custom reference with hg38 plus plasmid sequences
#download hg38 from ftp://ftp.ncbi.nlm.nih.gov/genomes/all/GCA/000/001/405/GCA_000001405.15_GRCh38/seqs_for_alignment_pipelines.ucsc_ids/GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.gz
#into 0_reference/
cd 0_reference/
gunzip GCA_000001405.15_GRCh38_no_alt_analysis_set.fna.gz
cat GCA_000001405.15_GRCh38_no_alt_analysis_set.fna DamLamPlasmid.fasta mTracerPlasmid.fasta > GRCh38_DamLMNB1_mTracer.fasta
../software/bwa-0.7.15/bwa index -a bwtsw GRCh38_DamLMNB1_mTracer.fasta
cd ..

#use trimmomatic to remove Illumina and DamID adapter sequences
for i in NA001 NA002 NA003 NA004 NA005 NA006 NA007 NA008 NA009 NA010 NA011 NA012 NA013 NA014 NA015 NA016 NA017 NA018; do
	java -jar software/Trimmomatic-0.39/trimmomatic-0.39.jar PE -threads 4 -trimlog tmp/$i.trimmomatic.log 1_raw/$i.R1.fastq.gz 1_raw/$i.R2.fastq.gz -baseout 2_trimmed/$i.trimmed.fastq ILLUMINACLIP:2_trimmed/adapters-PE.fa:2:30:10 LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:20
done

#use bwa mem to align paired and unpaired trimmed reads to custom reference
for i in NA001 NA002 NA003 NA004 NA005 NA006 NA007 NA008 NA009 NA010 NA011 NA012 NA013 NA014 NA015 NA016 NA017 NA018; do
	software/bwa-0.7.15/bwa mem -t 4 0_reference/GRCh38_DamLMNB1_mTracer.fasta 2_trimmed/$i.trimmed_1P.fastq 2_trimmed/$i.trimmed_2P.fastq | software/samtools-1.9/samtools view -S -u -h - | software/samtools-1.9/samtools sort -@ 4 - 3_aligned/$i.GRCh38.sorted
	software/bwa-0.7.15/bwa mem -t 4 0_reference/GRCh38_DamLMNB1_mTracer.fasta 2_trimmed/$i.trimmed_1U.fastq | software/samtools-1.9/samtools view -S -u -h - | software/samtools-1.9/samtools sort -@ 4 - 3_aligned/$i.1U.GRCh38.sorted
	software/bwa-0.7.15/bwa mem -t 4 0_reference/GRCh38_DamLMNB1_mTracer.fasta 2_trimmed/$i.trimmed_2U.fastq | software/samtools-1.9/samtools view -S -u -h - | software/samtools-1.9/samtools sort -@ 4 - 3_aligned/$i.2U.GRCh38.sorted
done

#use samtools to merge paired and unpaired trimmed reads, filter to mapq>0
for i in NA001 NA002 NA003 NA004 NA005 NA006 NA007 NA008 NA009 NA010 NA011 NA012 NA013 NA014 NA015 NA016 NA017 NA018; do
	software/samtools-1.9/samtools merge -f 4_merged/$i.GRCh38.sepe.bam 3_aligned/$i.GRCh38.sorted.bam 3_aligned/$i.1U.GRCh38.sorted.bam 3_aligned/$i.2U.GRCh38.sorted.bam
	software/samtools-1.9/samtools index 4_merged/$i.GRCh38.sepe.bam
	software/samtools-1.9/samtools view -bh -q1 -o 4_merged/$i.GRCh38.sepe.q1.bam 4_merged/$i.GRCh38.sepe.bam
	software/samtools-1.9/samtools index 4_merged/$i.GRCh38.sepe.q1.bam
done

#generate list of all fragments generated by in silico DpnI digestion of all GATC sites in the reference
perl software/GetGATCfrags_v4.pl 0_reference/GRCh38_DamLMNB1_mTracer.fasta 5_fragcov/GRCh38_ALL_DpnI_Fragments_v4.bed

#use bedtools to create a set of DpnI fragments overlapped by >=1 reads
for i in NA001 NA002 NA003 NA004 NA005 NA006 NA007 NA008 NA009 NA010 NA011 NA012 NA013 NA014 NA015 NA016 NA017 NA018; do
	software/bedtools2/bin/bedtools intersect -u -a 5_fragcov/GRCh38_ALL_DpnI_Fragments_v4.bed -b 4_merged/$i.GRCh38.sepe.q1.bam >5_fragcov/$i.DamFragCov.q1.gte1.bed
done

#now compute unique fragment coverage in 250kb bins across the genome, adding to logFC values from bulk data analysis
cd 6_LADcov/
cp -f coverage_logFC_250kb_BulkHEK293T.bed coverage_logFC_250kb_ALLscCov.bed
for i in NA001 NA002 NA003 NA004 NA005 NA006 NA007 NA008 NA009 NA010 NA011 NA012 NA013 NA014 NA015 NA016 NA017 NA018; do
	../software/bedtools2/bin/bedtools intersect -c -a coverage_logFC_250kb_BulkHEK293T.bed -b ../5_fragcov/$i.DamFragCov.q1.gte1.bed | cut -f 9 - | paste coverage_logFC_250kb_ALLscCov.bed - >temp.txt
	mv -f temp.txt coverage_logFC_250kb_ALLscCov.bed
done

#add flags for bins called as 'gold' cLADs or ciLADs given bulk data and data from other cell lines
cp -f coverage_logFC_250kb_ALLscCov.bed coverage_logFC_250kb_ALLscCov_goldflags.bed
software/bedtools2/bin/bedtools intersect -c -a coverage_logFC_250kb_BulkHEK293T.bed -b cLAD_gold_final_250kb.bed | cut -f 9 - | paste coverage_logFC_250kb_ALLscCov_goldflags.bed - >temp.txt
mv -f temp.txt coverage_logFC_250kb_ALLscCov_goldflags0.bed
software/bedtools2/bin/bedtools intersect -c -a coverage_logFC_250kb_BulkHEK293T.bed -b ciLAD_gold_final_250kb.bed | cut -f 9 - | paste coverage_logFC_250kb_ALLscCov_goldflags.bed - >temp.txt
mv -f temp.txt coverage_logFC_250kb_ALLscCov_goldflags.bed
software/bedtools2/bin/bedtools sort -i coverage_logFC_250kb_ALLscCov_goldflags.bed -g ../GRCh38.chromsizes.txt >coverage_logFC_250kb_ALLscCov_goldflags.sorted.bed
#note: identical pipeline was applied to merged coverage from Kind et al. single cells to generate coverage_logFC_250kb_Kind_AllCells.DamLam.bed and coverage_logFC_250kb_Kind_AllCells.DamOnly.bed


#count the number of mapped q1 reads mapping to plasmids vs genome, compute proportions
for i in NA001 NA002 NA003 NA004 NA005 NA006 NA007 NA008 NA009 NA010 NA011 NA012 NA013 NA014 NA015 NA016 NA017 NA018; do
	software/samtools-1.9/samtools view -c 4_merged/$i.GRCh38.sepe.q1.bam
	software/samtools-1.9/samtools view -c 4_merged/$i.GRCh38.sepe.q1.bam DamLMNB1_plasmid:1-8276
	software/samtools-1.9/samtools view -c 4_merged/$i.GRCh38.sepe.q1.bam mTracer_plasmid:1-5089
done
#resulting proportions: 0.1271,0.1359,0.0035,0.0128,0.0246,0.0160,0.0359,0.0260,0.0258,0.0382,0.0349,0.1698,0.0373,0.0481,0.0243,0.0305,0.0093,0.0034

